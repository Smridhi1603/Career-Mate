<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Career Mate : AI Study Assistant</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap"
        rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <style>
        .chat-container {
            height: 600px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .message.bot .audio-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        /* New CSS for Markdown Formatting */
        .message.bot p {
            margin-bottom: 0.5rem;
        }

        .message.bot ul,
        .message.bot ol {
            padding-left: 20px;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* End of new CSS */

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            border: 1px solid #e0e0e0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-area textarea {
            resize: none;
            border-radius: 25px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
        }

        .chat-input-area textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .send-btn {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-question-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-question-btn:hover {
            background: #667eea;
            color: white;
        }

        .audio-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .audio-btn:hover {
            background: #f0f0f0;
        }

        .audio-btn.playing {
            color: #28a745;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message i {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
        <a href="index.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <p class="m-0 fw-bold" style="font-size: 25px;">Career<span style="color: royalblue;">Mate</span></p>
        </a>
        <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <a href="index.html" class="nav-item nav-link">Home</a>
                <a href="about.html" class="nav-item nav-link">About</a>
                <a href="courses.html" class="nav-item nav-link">Courses</a>
                <a href="dashboard.html" class="nav-item nav-link">Dashboard</a>
                <a href="study-assistant.html" class="nav-item nav-link active">AI Assistant</a>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Pages</a>
                    <div class="dropdown-menu fade-down m-0">
                        <a href="team.html" class="dropdown-item">Our Team</a>
                    </div>
                </div>
                <a href="contact.html" class="nav-item nav-link">Contact</a>
                <a href="login.html" class="nav-item nav-link">Login</a>
                <a href="signup.html" class="nav-item nav-link">Signup</a>
            </div>
        </div>
    </nav>
    <div class="container-fluid bg-primary py-5 mb-5 page-header">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center">
                    <h1 class="display-3 text-white animated slideInDown">AI Study Assistant</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-center">
                            <li class="breadcrumb-item"><a class="text-white" href="index.html">Home</a></li>
                            <li class="breadcrumb-item text-white active" aria-current="page">AI Assistant</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <div class="container-xxl py-5">
        <div class="container">
            <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
                <h6 class="section-title bg-white text-center px-3">Ask Anything</h6>
                <h1 class="mb-5" style="color: royalblue;">Your Personal AI Tutor</h1>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="quick-questions mb-4">
                        <button class="quick-question-btn" onclick="askQuestion('Explain JavaScript closures')">
                            <i class="fas fa-code me-2"></i>Explain JavaScript closures
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('What is React?')">
                            <i class="fab fa-react me-2"></i>What is React?
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('How to learn Python?')">
                            <i class="fab fa-python me-2"></i>How to learn Python?
                        </button>
                        <button class="quick-question-btn" onclick="askQuestion('Best practices for CSS?')">
                            <i class="fab fa-css3-alt me-2"></i>CSS Best Practices
                        </button>
                    </div>

                    <div class="card shadow-lg">
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <div class="welcome-message">
                                    <i class="fas fa-robot"></i>
                                    <h4>Hello! I'm your AI Study Assistant ðŸ‘‹</h4>
                                    <p>Ask me anything about programming, web development, or any course topic!</p>
                                    <p class="text-muted"><small>I can respond in both text and audio format</small></p>
                                </div>
                            </div>

                            <div class="chat-input-area">
                                <div class="d-flex gap-2">
                                    <textarea id="userInput" class="form-control" rows="2"
                                        placeholder="Type your question here... (Press Enter to send)"
                                        onkeydown="handleKeyPress(event)"></textarea>
                                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <div class="mt-2 text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Press Enter to send, Shift+Enter for new line
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card text-center p-3">
                                <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                <h6>AI-Powered</h6>
                                <small class="text-muted">Advanced AI understands your questions</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center p-3">
                                <i class="fas fa-volume-up fa-2x text-success mb-2"></i>
                                <h6>Audio Responses</h6>
                                <small class="text-muted">Listen to answers on the go</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center p-3">
                                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                <h6>24/7 Available</h6>
                                <small class="text-muted">Get help anytime, anywhere</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-light footer pt-5 mt-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-white mb-3">Quick Link</h4>
                    <p><a class="text-light" href="about.html">About Us</a></p>
                    <p><a class="text-light" href="contact.html">Contact Us</a></p>
                    <p><a class="text-light" href="">Privacy Policy</a></p>
                    <p><a class="text-light" href="">Terms & Condition</a></p>
                    <p><a class="text-light" href="">FAQs & Help</a></p>
                </div>
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-white mb-3">Contact</h4>
                    <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>Chitkara University</p>
                    <p class="mb-2"><i class="fa fa-phone-alt me-3"></i>+91 8120800786</p>
                    <p class="mb-2"><i class="fa fa-envelope me-3"></i>tanishach2005@gmail.com</p>
                    <div class="d-flex pt-2">
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-twitter"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-youtube"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/init.js"></script>
    <script src="js/navbar.js"></script>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        let currentAudio = null;

        // Handle Enter key press for sending messages
        function handleKeyPress(event) {
            // Check if Enter is pressed and Shift is not held down
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent default enter behavior
                const message = userInput.value.trim();
                if (message) { // Only send if there's a message
                    sendMessage();
                }
            }
        }

        // Quick question buttons
        function askQuestion(question) {
            userInput.value = question;
            sendMessage();
        }

        // Send message
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Clear input, focus back on textarea, and disable send button
            userInput.value = '';
            userInput.focus();
            sendBtn.disabled = true;

            // Remove welcome message if exists
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            // Add user message
            addMessage(message, 'user');

            // Show typing indicator
            const typingId = showTypingIndicator();

            try {
                // Call Gemini AI API directly
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': 'AIzaSyDJ7ey6dUAnEjbbJZ-plvOUE30wMIdSqxk'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: message
                            }]
                        }]
                    })
                });

                // Remove typing indicator
                removeTypingIndicator(typingId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data && data.candidates && data.candidates[0].content.parts[0].text) {
                    // Get the response text from Gemini API
                    const reply = data.candidates[0].content.parts[0].text;
                    // Add bot response with audio capability
                    addMessage(reply, 'bot', true);
                } else {
                    throw new Error('Invalid response format');
                }

            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator(typingId);
                addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'bot');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
            }

            // Re-enable send button
            sendBtn.disabled = false;
        }

        // Add message to chat
        function addMessage(text, sender, enableAudio = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const textDiv = document.createElement('div');
            // --- MODIFIED LINE START ---
            textDiv.innerHTML = formatMarkdown(text);
            // --- MODIFIED LINE END ---
            messageDiv.appendChild(textDiv);

            // Add audio controls for bot messages
            if (sender === 'bot' && enableAudio) {
                const audioControls = document.createElement('div');
                audioControls.className = 'audio-controls';
                const btnId = 'audio-btn-' + Date.now();

                // Create the button element directly instead of using innerHTML
                const audioButton = document.createElement('button');
                audioButton.className = 'audio-btn';
                audioButton.id = btnId;
                audioButton.innerHTML = '<i class="fas fa-volume-up"></i> Listen to answer';

                // Add click event listener
                audioButton.addEventListener('click', () => speakText(text, btnId));

                audioControls.appendChild(audioButton);
                messageDiv.appendChild(audioControls);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-' + Date.now();
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv.id;
        }

        // Remove typing indicator
        function removeTypingIndicator(id) {
            const typing = document.getElementById(id);
            if (typing) typing.remove();
        }

        // Text-to-Speech using Web Speech API (FREE!)
        let currentSpeech = null;
        let voices = [];

        // Initialize voices
        function initVoices() {
            return new Promise((resolve) => {
                voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    window.speechSynthesis.onvoiceschanged = () => {
                        voices = window.speechSynthesis.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        async function speakText(text, buttonId) {
            const button = document.getElementById(buttonId);

            // If there's speech playing and this is the active button, stop it
            if (currentSpeech && window.speechSynthesis.speaking && button.classList.contains('playing')) {
                window.speechSynthesis.cancel();
                button.innerHTML = '<i class="fas fa-volume-up"></i> Listen to answer';
                button.classList.remove('playing');
                currentSpeech = null;
                return; // Exit the function here to prevent restarting
            }

            // If there's another speech playing, stop it first
            if (currentSpeech && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                document.querySelectorAll('.audio-btn').forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> Listen to answer';
                    btn.classList.remove('playing');
                });
                currentSpeech = null;
            }

            try {
                // Initialize speech synthesis if needed
                if (!window.speechSynthesis) {
                    throw new Error('Speech synthesis not supported');
                }

                // Make sure voices are loaded
                if (voices.length === 0) {
                    await initVoices();
                }

                // Create new speech
                currentSpeech = new SpeechSynthesisUtterance(text);

                // Configure voice settings
                currentSpeech.rate = 0.9; // Slightly slower for clarity
                currentSpeech.pitch = 1;
                currentSpeech.volume = 1;

                // Try to find the best voice
                let englishVoice = voices.find(v =>
                    v.lang.startsWith('en') && v.name.includes('Google')
                ) || voices.find(v =>
                    v.lang.startsWith('en') && v.name.includes('Female')
                ) || voices.find(v =>
                    v.lang.startsWith('en')
                ) || voices[0];

                if (englishVoice) {
                    console.log('Selected voice:', englishVoice.name);
                    currentSpeech.voice = englishVoice;
                }

                // Update button state before starting speech
                button.innerHTML = '<i class="fas fa-stop-circle"></i> Stop';
                button.classList.add('playing');

                // Clean up any previous speech synthesis
                window.speechSynthesis.cancel();

                // Set up speech event handlers
                const resetButton = () => {
                    if (button) {
                        button.innerHTML = '<i class="fas fa-volume-up"></i> Listen to answer';
                        button.classList.remove('playing');
                    }
                    currentSpeech = null;
                };

                // Handle speech end
                currentSpeech.onend = resetButton;

                // Handle errors
                currentSpeech.onerror = (error) => {
                    console.error('Speech error:', error);
                    resetButton();
                };

                // Handle speech cancel
                currentSpeech.oncancel = resetButton;

                // Break text into chunks if it's too long (about 200 characters each)
                const chunks = [];
                const words = text.split(' ');
                let currentChunk = '';

                for (const word of words) {
                    if (currentChunk.length + word.length > 200) {
                        chunks.push(currentChunk.trim());
                        currentChunk = word;
                    } else {
                        currentChunk += ' ' + word;
                    }
                }
                if (currentChunk) {
                    chunks.push(currentChunk.trim());
                }

                // Speak each chunk
                for (let chunk of chunks) {
                    try {
                        currentSpeech.text = chunk;
                        window.speechSynthesis.speak(currentSpeech);

                        // Wait for chunk to finish before speaking next one
                        await new Promise((resolve, reject) => {
                            currentSpeech.onend = resolve;
                            currentSpeech.onerror = reject;

                            // Safety timeout in case speech synthesis hangs
                            setTimeout(() => {
                                window.speechSynthesis.cancel();
                                resolve();
                            }, 10000); // 10 second timeout
                        });
                    } catch (chunkError) {
                        console.error('Chunk speech error:', chunkError);
                        continue; // Try next chunk if one fails
                    }
                }

            } catch (error) {
                console.error('Speech synthesis error:', error);
                button.innerHTML = '<i class="fas fa-volume-up"></i> Listen to answer';
                button.classList.remove('playing');
                if (!window.speechSynthesis) {
                    alert('Sorry, text-to-speech is not available on your browser. Please try using Chrome or Edge.');
                } else {
                    alert('There was an error with the text-to-speech. Please try again.');
                }
            }
        }


        // Initialize text-to-speech and check authentication
        document.addEventListener('DOMContentLoaded', async function () {
            // Initialize text-to-speech
            if ('speechSynthesis' in window) {
                try {
                    await initVoices();
                    console.log('Text-to-speech initialized with', voices.length, 'voices');
                    console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`).join(', '));
                } catch (error) {
                    console.error('Failed to initialize text-to-speech:', error);
                }
            } else {
                console.warn('Text-to-speech not supported in this browser');
            }

            // Check authentication
            try {
                const response = await fetch('/api/auth/me');
                const userData = await response.json();

                if (!userData.loggedIn) {
                    // Show message but allow usage
                    console.log('User not logged in - limited features');
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        });
        // New function to convert basic Markdown to HTML
        // New function to convert basic Markdown to HTML
        function formatMarkdown(text) {
            // 1. Remove all standalone or extra asterisks/underscores often left by the AI
            let formattedText = text.replace(/(\*\*\*)/g, ''); // Remove triple asterisks: ***
            formattedText = formattedText.replace(/(\*\*+)/g, '**'); // Collapse multiple asterisks to double: **** -> **
            formattedText = formattedText.replace(/(\*+)/g, ''); // Remove single or any remaining asterisks: * // 2. Convert standard bold text: **text** to <strong>text</strong>
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 3. Convert list items starting with **-** or **\*** (sometimes created by AI) to normal HTML list structure
            formattedText = formattedText.replace(/\s*(\r?\n)[\t ]*([-\*][\t ].*)/g, '$1$2') // Clean up new lines for lists
            formattedText = formattedText.replace(/\r?\n\s*([-\*][\t ].*)/g, '<ul><li>$1</li></ul>') // Wrap lists
            formattedText = formattedText.replace(/<\/ul>(\r?\n)?<ul>/g, ''); // Collapse adjacent ul tags

            // 4. Convert headers (e.g., if any were mistakenly left)
            formattedText = formattedText.replace(/^([#]{1,3})[ \t](.+)/g, '<h4>$2</h4>');

            // 5. Handle Line Breaks and Paragraphs
            formattedText = formattedText.replace(/\n\n/g, '</p><p>');
            formattedText = formattedText.replace(/\n/g, '<br>');

            // 6. Final wrapping (ensure consistent paragraph block)
            if (!formattedText.startsWith('<p>') && !formattedText.startsWith('<ul>') && !formattedText.startsWith('<h')) {
                formattedText = '<p>' + formattedText + '</p>';
            }

            // 7. Clean up paragraph tags left over from list processing
            formattedText = formattedText.replace(/<br><\/p><p>/g, '</p><p>');
            formattedText = formattedText.replace(/<p><br>/g, '<p>');

            return formattedText;
        }
    </script>
</body>

</html>