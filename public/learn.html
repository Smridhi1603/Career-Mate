<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Career Mate : Learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: #f9f9f9; }
    .page-header { background: royalblue; }
    .sidebar-box { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <!-- Navbar Start -->
  <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
    <a href="index.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
      <p class="m-0 fw-bold" style="font-size: 25px;">Career<span style="color: royalblue;">Mate</span></p>
    </a>
    <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <div class="navbar-nav ms-auto p-4 p-lg-0">
        <a href="index.html" class="nav-item nav-link">Home</a>
        <a href="courses.html" class="nav-item nav-link">Courses</a>
        <a href="dashboard.html" class="nav-item nav-link">Dashboard</a>
        <a href="login.html" class="nav-item nav-link">Login</a>
        <a href="signup.html" class="nav-item nav-link">Signup</a>
      </div>
    </div>
  </nav>
  <!-- Navbar End -->

  <div class="container-fluid py-5 mb-5 page-header text-center text-white">
    <h1 id="course-title" class="display-4">Loading...</h1>
    <p id="course-subtitle"></p>
  </div>

  <div class="container py-4">
    <div id="enrollWarning" class="alert alert-warning d-none">You must enroll to access this content.</div>
    <div class="row g-4">
      <div class="col-lg-8">
        <h5 class="mb-2">Progress</h5>
        <div class="progress mb-3" aria-label="Progress bar">
          <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
        </div>
        <div id="videoContainer"></div>
        <div class="card mt-3">
          <div class="card-body" id="readingContent"></div>
        </div>
        <div class="d-flex gap-2 mt-3 flex-wrap">
          <button id="openQuizBtn" class="btn btn-success"><i class="fa fa-question-circle me-2"></i>Take Quiz</button>
          <a id="overviewBtn" class="btn btn-outline-secondary">Back to Overview</a>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="sidebar-box mb-3" id="sidebar"></div>
        <div class="sidebar-box">
          <h6 class="fw-bold">Lessons</h6>
          <ul id="lessonList" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function guardEnrollment(courseId) {
      try {
        const auth = await fetch('/api/auth/me').then(r=>r.json());
        if (!auth.loggedIn) return false;
        const enrolled = await fetch('/api/courses/enrolled').then(r=>r.json());
        return Array.isArray(enrolled.enrolledCourses) && enrolled.enrolledCourses.includes(courseId);
      } catch (_) { return false; }
    }

    async function loadProgress(courseId) {
      try {
        const res = await fetch(`/api/progress/${courseId}`);
        const data = await res.json();
        return data.progress || null;
      } catch { return null; }
    }

    async function saveProgress(courseId, payload) {
      await fetch('/api/progress/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ courseId, ...payload }) });
    }

    async function loadCourse() {
      const params = new URLSearchParams(location.search);
      const courseId = params.get('id');
      if (!courseId) { location.href = 'courses.html'; return; }

      const ok = await guardEnrollment(courseId);
      if (!ok) {
        document.getElementById('enrollWarning').classList.remove('d-none');
        setTimeout(()=> location.href = `course.html?id=${courseId}`, 1200);
        return;
      }

      const overviewBtn = document.getElementById('overviewBtn');
      overviewBtn.href = `course.html?id=${courseId}`;

      const res = await fetch('assets/courses.json');
      const data = await res.json();
      const course = (data.courses||[]).find(c=>c.id===courseId);
      if (!course) { location.href = 'courses.html'; return; }

      document.getElementById('course-title').innerText = course.title;
      document.getElementById('course-subtitle').innerText = course.subtitle || '';

      // Video
      const videoContainer = document.getElementById('videoContainer');
      if (course.videoUrl) {
        const ratio = document.createElement('div');
        ratio.className = 'ratio ratio-16x9';
        const iframe = document.createElement('iframe');
        iframe.src = course.videoUrl;
        iframe.title = 'Course video';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        ratio.appendChild(iframe);
        videoContainer.appendChild(ratio);
      } else {
        videoContainer.innerHTML = '<div class="alert alert-info">No video available for this course.</div>';
      }

      // Reading content
      const reading = document.getElementById('readingContent');
      (course.mainContent||[]).forEach(block => {
        if (block.tag === 'ul') {
          const ul = document.createElement('ul');
          (block.items||[]).forEach(item => { const li=document.createElement('li'); li.innerHTML=item; ul.appendChild(li); });
          reading.appendChild(ul);
        } else if (block.tag === 'pre') {
          const pre = document.createElement('pre'); pre.innerHTML = block.content||''; reading.appendChild(pre);
        } else {
          const el = document.createElement(block.tag||'p'); el.innerHTML = block.content||''; reading.appendChild(el);
        }
      });

      // Sidebar
      const includesList = (course.sidebar?.includes || []).map(i => `<li>${i}</li>`).join('');
      document.getElementById('sidebar').innerHTML = `
        <h5 class="fw-bold mb-3">Course Details</h5>
        <p><strong>Level:</strong> ${course.sidebar?.level || 'Beginner'}</p>
        <p><strong>Instructor:</strong> ${course.sidebar?.instructor || 'Instructor'}</p>
        <p><strong>Includes:</strong></p>
        <ul>${includesList}</ul>
        <a href="dashboard.html" class="btn btn-success w-100"><i class="fa fa-check me-2"></i>Enrolled</a>
      `;

      // Build lesson checklist from headings
      const headings = Array.from(document.querySelectorAll('#readingContent h3'));
      const lessonList = document.getElementById('lessonList');
      const totalLessons = Math.max(headings.length, 1);
      const progress = await loadProgress(courseId) || {};
      const completed = new Set((progress.completedLessons || []));

      const updateProgressUI = () => {
        const done = completed.size;
        const pct = Math.round((done / totalLessons) * 100);
        const bar = document.getElementById('progressBar');
        bar.style.width = pct + '%';
        bar.textContent = pct + '%';
        document.getElementById('openQuizBtn').disabled = done < totalLessons; // unlock quiz when all lessons checked
      };

      headings.forEach((h, idx) => {
        const id = 'lesson-' + (idx + 1);
        h.setAttribute('data-lesson-id', id);
        const li = document.createElement('li');
        const checked = completed.has(id) ? 'checked' : '';
        li.innerHTML = `<label class="d-flex align-items-center gap-2"><input type="checkbox" ${checked} data-id="${id}"> ${h.textContent}</label>`;
        lessonList.appendChild(li);
      });

      lessonList.addEventListener('change', async (e) => {
        const input = e.target;
        if (input && input.type === 'checkbox') {
          const id = input.getAttribute('data-id');
          if (input.checked) {
            await fetch('/api/progress/complete-lesson', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ courseId, lessonId: id })});
            completed.add(id);
          } else {
            await fetch('/api/progress/uncomplete-lesson', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ courseId, lessonId: id })});
            completed.delete(id);
          }
          updateProgressUI();
        }
      });

      updateProgressUI();

      document.getElementById('openQuizBtn').addEventListener('click', ()=>{
        window.location.href = `quiz.html?id=${courseId}`;
      });
    }

    loadCourse();
  </script>
  <script src="js/navbar.js"></script>
</body>
</html>
