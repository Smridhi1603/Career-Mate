<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Career Mate : Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; }
    .page-header { background: royalblue; }
  </style>
</head>
<body>
  <div class="container-fluid py-4 mb-4 page-header text-center text-white">
    <h1 class="display-6">Course Quiz</h1>
    <p id="quizSubtitle" class="mb-0"></p>
  </div>

  <div class="container">
    <div id="lockMsg" class="alert alert-warning d-none">You must be enrolled to take this quiz.</div>
    <div id="quizCard" class="card shadow-sm">
      <div class="card-body">
        <h5 id="courseTitle" class="card-title mb-3">Loading...</h5>
        <form id="quizForm"></form>
        <div class="d-flex gap-2 mt-3">
          <button id="submitBtn" class="btn btn-primary">Submit Quiz</button>
          <a id="backBtn" class="btn btn-outline-secondary">Back to Learn</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function guardEnrollment(courseId) {
      try {
        const auth = await fetch('/api/auth/me').then(r=>r.json());
        if (!auth.loggedIn) return false;
        const enrolled = await fetch('/api/courses/enrolled').then(r=>r.json());
        return Array.isArray(enrolled.enrolledCourses) && enrolled.enrolledCourses.includes(courseId);
      } catch (_) { return false; }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderQuiz(formEl, questions){
      formEl.innerHTML = '';
      questions.forEach((q, i) => {
        const block = document.createElement('div');
        block.className = 'mb-3';
        block.innerHTML = `<p class="fw-bold mb-1">${i+1}. ${escapeHtml(q.q)}</p>` +
          q.options.map((opt, idx) => `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q${i}" id="q${i}_${idx}" value="${idx}" required>
              <label class="form-check-label" for="q${i}_${idx}">${idx+1}) ${escapeHtml(opt)}</label>
            </div>
          `).join('');
        formEl.appendChild(block);
      });
    }

    async function loadQuiz(){
      const params = new URLSearchParams(location.search);
      const courseId = params.get('id');
      if (!courseId) { location.href = 'courses.html'; return; }
      document.getElementById('backBtn').href = `learn.html?id=${courseId}`;

      const ok = await guardEnrollment(courseId);
      if (!ok) {
        document.getElementById('lockMsg').classList.remove('d-none');
        document.getElementById('quizCard').classList.add('d-none');
        return;
      }

      const courseRes = await fetch('assets/courses.json');
      const courseData = await courseRes.json();
      const course = (courseData.courses||[]).find(c=>c.id===courseId) || { title: courseId.toUpperCase() };
      document.getElementById('courseTitle').textContent = `${course.title} â€” Quiz`;
      document.getElementById('quizSubtitle').textContent = 'Answer all 4 questions. Score 3 or more to pass and earn your certificate!';

      // Load questions
      let qs = [];
      try {
        const r = await fetch('assets/quizzes.json');
        const qz = await r.json();
        qs = (qz.quizzes && qz.quizzes[courseId]) || [];
      } catch(_) {}

      // Ensure exactly 4 questions; if fewer, create simple placeholders
      if (qs.length < 4) {
        qs = [1,2,3,4].map(i => ({ q: `Sample question ${i}?`, options: ['Option 1','Option 2 (correct)','Option 3','Option 4'] }));
      } else {
        qs = qs.slice(0,4);
        // Force hint so option 2 is intended correct
        qs = qs.map(q => ({ q: q.q, options: q.options && q.options.length>=4 ? q.options : ['A','B (correct)','C','D'] }));
      }

      const form = document.getElementById('quizForm');
      renderQuiz(form, qs);

      document.getElementById('submitBtn').addEventListener('click', async (e)=>{
        e.preventDefault();
        
        // Validate all questions answered
        const total = 4;
        for (let i=0; i<total; i++){
          const sel = form.querySelector(`input[name="q${i}"]:checked`);
          if (!sel) {
            alert('Please answer all questions before submitting!');
            return;
          }
        }
        
        // Grade: answer must be option 2 => index 1
        let correct = 0;
        for (let i=0;i<total;i++){
          const sel = form.querySelector(`input[name="q${i}"]:checked`);
          const idx = sel ? Number(sel.value) : -1;
          if (idx === 1) correct++;
        }
        
        const passed = correct >= 3; // 75% or higher
        
        // Save quiz result
        try {
          const resp = await fetch('/api/quiz/submit', { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({ courseId, score: correct, total })
          });
          const data = await resp.json();
          
          if (!resp.ok) {
            alert(data.message || 'Error saving quiz results');
            return;
          }
          
          // Show score
          if (passed) {
            alert(`ðŸŽ‰ Congratulations!\n\nYour Score: ${correct}/${total}\n\nYou passed! Generating your certificate...`);
            // Redirect directly to certificate with course info
            window.location.href = `certificate.html?courseId=${courseId}&score=${correct}&total=${total}`;
          } else {
            alert(`Your score: ${correct}/${total}\n\nâŒ You need 3 or more correct answers to pass.\n\nPlease try again!`);
            setTimeout(() => location.reload(), 2000);
          }
        } catch (error) {
          console.error('Quiz submission error:', error);
          alert('Error submitting quiz. Please check your connection and try again.');
        }
      });
    }

    loadQuiz();
  </script>
</body>
</html>
